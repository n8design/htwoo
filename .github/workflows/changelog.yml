name: 'Changelog Generation'

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project to generate changelog for'
        required: false
        default: 'htwoo-core'
        type: choice
        options:
          - 'htwoo-core'
          - 'htwoo-react'
          - 'all'
      release_type:
        description: 'Type of release'
        required: false
        default: 'patch'
        type: choice
        options:
          - 'patch'
          - 'minor'
          - 'major'
      dry_run:
        description: 'Dry run (preview only)'
        required: false
        default: true
        type: boolean

  push:
    branches: [main]
    paths:
      - 'htwoo-core/**'
      - 'htwoo-react/**'

jobs:
  changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Check workspace health
        run: node scripts/workspace-changelog.js --check

      - name: Generate changelog (Dry Run)
        if: ${{ inputs.dry_run == true || github.event_name == 'push' }}
        run: |
          if [ "${{ inputs.project }}" = "all" ] || [ -z "${{ inputs.project }}" ]; then
            nx run htwoo-core:changelog:preview
          else
            nx run ${{ inputs.project }}:changelog:preview
          fi

      - name: Generate changelog and create release
        if: ${{ inputs.dry_run == false && github.event_name == 'workflow_dispatch' }}
        run: |
          if [ "${{ inputs.project }}" = "all" ]; then
            node scripts/workspace-changelog.js
          elif [ -n "${{ inputs.project }}" ]; then
            nx run ${{ inputs.project }}:changelog
          else
            nx run htwoo-core:changelog
          fi

      - name: Create Release PR
        if: ${{ inputs.dry_run == false && github.event_name == 'workflow_dispatch' }}
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update changelog for ${{ inputs.project }}'
          title: 'chore: update changelog for ${{ inputs.project }}'
          body: |
            ## Changelog Update
            
            This PR contains an automated changelog update for `${{ inputs.project }}`.
            
            ### Changes
            - Updated CHANGELOG.md with latest commits
            - Synced changelog to documentation
            - Updated package metadata
            
            Generated by GitHub Actions workflow.
          branch: changelog-update-${{ inputs.project }}-${{ github.run_number }}
          delete-branch: true

      - name: Upload changelog artifacts
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ inputs.project || 'htwoo-core' }}-${{ github.run_number }}
          path: |
            htwoo-core/CHANGELOG.md
            htwoo-core/LATEST-CHANGES.md
            docs/change-log/htwoo-core.md
          retention-days: 30
